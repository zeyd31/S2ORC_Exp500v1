
AN ASYMPTOTIC VERSION OF THE PRIME POWER CONJECTURE FOR PERFECT DIFFERENCE SETS
Jan 2023

Sarah Peluse 
AN ASYMPTOTIC VERSION OF THE PRIME POWER CONJECTURE FOR PERFECT DIFFERENCE SETS
5Jan 2023
We show that the number of positive integers n ≤ N such that Z/(n 2 + n + 1)Z contains a perfect difference set is asymptotically N log N .

Introduction

A subset D ⊂ Z/mZ is a perfect difference set if every nonzero a ∈ Z/mZ can be written uniquely as the difference of two elements of D. For example, {1, 2, 4} ⊂ Z/7Z is a perfect difference set. By a simple counting argument, if D ⊂ Z/mZ is a perfect difference set, then we must have m = n 2 + n + 1 and |D| = n + 1 for some integer n. In this situation, we say that the perfect difference set D has order n. Aside from being large Sidon sets, so that their existence and construction is of interest in additive number theory, perfect difference sets are also important objects of study in design theory and finite geometry (see the detailed account in [13]). Indeed, any perfect difference set D of order n gives rise to a finite projective plane of order n by taking the set of points to be Z/(n 2 + n + 1)Z and the set of lines to be translates of D.

Singer [18] constructed perfect difference sets of every prime power order, and it is an old conjecture that these are the only orders for which perfect difference sets exist (see, for example, [10], [6], or [9, C10]). This conjecture is now referred to in the literature as the "prime power conjecture", and has been verified computationally for all n up to 2 billion by Baumert and Gordon [2]. Conjecture 1.1 (The prime power conjecture). An integer n ≥ 2 is the order of a perfect difference set if and only if n is a prime power.

There are many partial results towards the prime power conjecture, though the conjecture itself seems out of reach. Some of the more general results say that all or almost all of the integers in certain congruence classes cannot be the order of a perfect difference set. For example, Bruck and Ryser [3] showed that if n is the order of a projective plane and n ≡ 1, 2 (mod 4), then n can be written as the sum of two squares, Jungnickel and Vedder [14] showed that if n is the order of a perfect difference set and 2 | n, then n = 2, n = 4, or 8 | n, and Willbrink [21] showed that if n is the order of a perfect difference set and 3 | n, then n = 3 or 9 | n. There are apparently no results saying that the set of orders of perfect difference sets has density zero in the integers, however.

In this paper, we prove that the set of orders of perfect difference sets has the asymptotic size predicted by the prime power conjecture. This gives further evidence for the truth of the prime power conjecture, and implies that if counterexamples exist, they must be sparser than the primes. The proof of Theorem 1.2 gives the explicit expression O(exp(−C log log log log log N log log log log log log N )) for the o(1) term above, though we made no serious attempt to optimize this bound.

To prove Theorem 1.2, we begin by splitting the set of n ≤ N up into various subsets depending on the prime factorization of n 2 + n+ 1. To each of these sets, we apply one of two results from the theory of perfect difference sets. Both say that if n is the order of a perfect difference set, then certain relations between the prime factors of n and the prime factors of n 2 + n + 1 must hold. Applying these results thus turns the problem of proving Theorem 1.2 into that of bounding the size of sets defined by various number-theoretic conditions. The remainder of this paper is organized as follows. In Section 2, we state the results on perfect difference sets used in the proof of Theorem 1.2 and, in Section 3, give an outline of the argument. We count the number of non-prime-power orders n ≤ N of perfect difference sets such that n 2 + n + 1 has at least three, exactly two, and exactly one prime factor(s) in Sections 4, 5, and 6, respectively. The arguments in Sections 5 and 6 depend on estimates for the number of lattice points satisfying various size and congruence restrictions on certain hyperboloids. We delay the proofs of these lattice point counting results to Sections 7 and 8.


Acknowledgments

The author thanks Ben Green and Kannan Soundararajan for helpful conversations and comments on earlier drafts of this paper and the anonymous referee for many useful suggestions. The author is supported by the NSF Mathematical Sciences Postdoctoral Research Fellowship Program under Grant No. DMS-1903038


Notation and preliminaries

We will first set some notation. For each k ∈ N, let log k denote the k-fold iterated logarithm, so that, for example, log 3 x = log log log x. No logarithms to any base other than e appear in this paper, so confusion should not arise. If D ⊂ Z/mZ and t, a ∈ Z/mZ, we define the sets t·D and a+D to be {td : d ∈ D} and {a+d : d ∈ D}, respectively. Throughout this paper, p and q will always denote prime numbers. For any Dirichlet character χ and y > 0, let L(1, χ; y) denote the Euler product p<y (1 − χ(p)/p) −1 . For any a ∈ Z/pZ, we will use δ a to denote the function that is 1 at a and 0 otherwise. For every prime q > 2, set q * := (−1) q−1 2 q. For every n, k ∈ N, we let p k (n) denote the k th smallest prime factor of n with the convention that p k (n) = ∞ if ω(n) < k, so that p 1 (n) < · · · < p k (n) whenever ω(n) ≥ k. Letting P denote the set of prime powers, we set S(N) := {n ≤ N : Z/(n 2 + n + 1)Z contains a perfect difference set} \ P, the set of non-prime-power orders of perfect difference sets in {1, . . . , N}. By Singer's construction, to prove Theorem 1.2 it suffices to show that #S(N) = o( N log N ). We now state the two results from the theory of perfect difference sets used in this paper. The first is due to Mann [17]. [17]). Let n be the order of a perfect difference set, and assume that n is not a perfect square. If p and q are primes such that p | n and q | n 2 + n + 1, then p is a quadratic residue modulo q.
Theorem 2.1 (Mann,
Note that the condition imposed by Mann's theorem is empty when n 2 + n + 1 is a prime congruent to 1 modulo 4, which we expect to happen for ≫ N log N of the n ≤ N by the Bateman-Horn conjecture. Indeed, since n 2 + n + 1 ≡ 1 (mod n), quadratic reciprocity tells us that every odd prime dividing n is a square modulo n 2 + n + 1 whenever n 2 + n + 1 is a prime congruent to 1 modulo 4. The contribution of such n must be dealt with if we want to prove Theorem 1.2, and not just a weaker big-O result. To do so, we will use the following lemma.

Lemma 2.2. Let n be the order of a perfect difference set, and assume that q := n 2 + n + 1 is prime and q ≡ 1 (mod 4). If p is a prime such that p | n, then p is a quartic residue modulo q.

To prove Lemma 2.2, we will need some basic facts from the theory of multipliers of perfect difference sets. Definition 2.3. Let D be a perfect difference set of order n. We say that t ∈ (Z/(n 2 + n + 1)Z) × is a numerical multiplier for D if t · D = a + D for some a ∈ Z/(n 2 + n + 1)Z.

Note that the set of numerical multipliers of a perfect difference set is closed under multiplication. Mann showed that every perfect difference set has a translate that is fixed by all of its numerical multipliers (this result is attributed to Mann by Hall in [10]), and Hall [10] showed that if D is a perfect difference set of order n, then every prime dividing n is a numerical multiplier of D.

Proof of Lemma 2.2. We may assume, without loss of generality, that D is fixed under multiplication by any of its numerical multipliers. Note that −1 cannot be a numerical multiplier of D. Indeed, we must have |D| ≥ 3, so that there exist distinct d,
d ′ ∈ D such that d = −d ′ . Observe, however, that d − d ′ = (−d ′ ) − (−d), so that no such perfect difference set D can satisfy D = −D.
By Hall's result, we have that p i ≡ −1 (mod q) for any i ≥ 0, so that p must have odd multiplicative order modulo q. Since 4 | q − 1, this implies that p must be a quartic residue modulo q.

3. Outline of the proof of Theorem 1.2 Given Theorem 2.1 and Lemma 2.2, it should not be surprising that #S(N) = o( N log N ). Indeed, for a typical integer n, one of n or n 2 + n + 1 will have enough prime factors that the conditions imposed by these results should be very rarely satisfied. The difficulty with turning this heuristic into a proof is that n 2 + n + 1 (and thus its prime factors) obviously depends on n. The conditions in Theorem 2.1 and Lemma 2.2 are sufficiently powerful, however, that we can afford to use the union bound in several places, which allows us to remove the dependence of the prime factors of n 2 + n + 1 on a few of the small prime factors of n. To do this effectively, we must use different techniques depending on the prime factorization of n 2 + n + 1.

The contribution to #S(N) coming from n such that n 2 + n + 1 has at least three prime factors is the most straightforward to handle. Typically, such n are divisible by two distinct primes p 1 and p 2 satisfying 3 = p 1 , p 2 ≤ N 1 1000 , say (the number of such n ∈ S(N) not satisfying this condition can be shown to be ≪ N (log N ) 3/2 (log 2 N) O(1) using an argument similar to the one about to be sketched). Thus, since n 2 + n + 1 must have a prime divisor below N 2 3 in this situation, by using the union bound and Theorem 2.1 it suffices to bound
(3.1) q≤N 2 3 p 1 <p 2 ≤N 1 1000 3 =p 1 ,p 2 #S q p 1 ,p 2 (N),
where S q p 1 ,p 2 (N) equals n ≤ N : p 1 p 2 | n, q | n 2 + n + 1, and p ′ | n, q ′ | n 2 + n + 1 =⇒
p ′ q = p 1 q ′ = p 2 q ′ = 1 .
Bounding the size of each S q p 1 ,p 2 (N) is a sieve problem of dimension 5 4 , the key being that 
O         q≤N 2 3 p 1 <p 2 ≤N 1 1000 3 =p 1 ,p 2
(an Euler product that is typically small)
p 1 p 2 q         ,
which we can bound by a power of log 2 N.

To estimate the number of n ∈ S(N) such that n 2 +n+1 = q 1 q 2 for two primes q 1 < q 2 , we must split into subcases depending on the size of q 1 . When q 1 ≤ N (log N ) β for β > 0 sufficiently large, an argument similar to the one above can be used. When N (log N ) β ≤ q 1 ≤ N (log N ) 1/2 , a more delicate argument is required. To deal with this subcase, we split such n up based on the smallest k = k(N) → ∞ prime factors of n below log 3 N (the number of such n without k prime factors below log 3 N is negligible), so that, by Theorem 2.1, only asymptotically 2 −k times the number of primes q in the interval [ N (log N ) β , N (log N ) 1/2 ] can possibly divide n 2 + n + 1. We then take the union bound over these q, apply an upper bound sieve, and sum over q and the k-tuples of distinct primes below log 3 N. Finally, to deal with the subcase N (log N ) 1/2 ≤ q 1 ≤ N, we forget the condition n ∈ S(N) and show, using an enveloping sieve argument, that there are ≪ N (log N ) 3/2 many n ≤ N such that n 2 + n + 1 = q 1 q 2 with q 1 < q 2 and N (log N ) 1/2 ≤ q 1 ≤ N. One of the key inputs is an asymptotic count, with power saving error term, for the number of integer triples (x, y, z) on the hyperboloid y 2 − 4xz = −3 satisfying 1 ≤ x, z ≤ X, k | x, and ℓ | z, for a variety of k and ℓ. We prove an estimate for the number of these lattice points by adapting an argument of Hooley [12].

When n 2 + n + 1 is a prime, different arguments are required depending on whether n 2 + n + 1 is congruent to 1 or 3 modulo 4. The number of n ∈ S(N) such that n 2 + n + 1 is a prime congruent to 3 modulo 4 can be bounded easily using an upper bound sieve-it follows from Theorem 2.1 and quadratic reciprocity that if n is not a perfect square, then every odd prime p | n must satisfy p ≡ 1 (mod 4). The situation when n 2 + n + 1 is congruent to 1 modulo 4 is much more involved. As in the second subcase of the paragraph above, we begin by splitting such n up based on the smallest k prime factors p 1 , . . . , p k of n, but this time apply Lemma 2.2 to get that p 1 , . . . , p k must all be quartic residues modulo n 2 + n + 1. By one of the formulations of the quartic reciprocity law, this forces n 2 + n + 1 to be representable by the quadratic form x 2 + 4y 2 with y satisfying certain congruence conditions that depend on p 1 , . . . , p k . We bound the number of such n by combining the Selberg sieve with an asymptotic count, with power-saving error term, for the number of integer triples (x, y, z) on the hyperboloid 4x 2 + 16y 2 − z 2 = 3 satisfying 1 ≤ z ≤ X and various congruence restrictions on y and z. The proof of this lattice point counting result is also an adaptation of the previously mentioned argument of Hooley, though the argument ends up being significantly more complicated than the one for the other lattice point count. 4. n 2 + n + 1 has at least three prime factors

In this section, we bound the number of n ∈ S(N) such that n 2 + n + 1 has at least three prime factors:
Proposition 4.1. We have #{n ∈ S(N) : Ω(n 2 + n + 1) ≥ 3} ≪ N (log N) 5 4 (log 2 N) 3 .
We split the estimation of the number of n ∈ S(N) such that n 2 + n + 1 has at least three prime factors into the estimation of the size of the following three sets:

{n ∈ S(N) : 3 ∤ n, p 2 (n) > N α , and Ω(n 2 + n + 1) ≥ 3}, {n ∈ S(N) : 3 | n, p 3 (n) > N α , and Ω(n 2 + n + 1) ≥ 3}, and {n ∈ S(N) : p 1 p 2 | n for some p 1 < p 2 ≤ N α with p 1 , p 2 = 3 and Ω(n 2 + n + 1) ≥ 3}, for some 0 < α < 1 6 to be fixed shortly. Note that if n ∈ N is not divisible by two distinct primes p 1 , p 2 ≤ N α with p 1 , p 2 = 3, then either 3 ∤ n and the second smallest prime factor of n has size at least N α , or 3 | n and n either has at most two prime factors or (since 3 must then be either the smallest or second smallest prime factor of n) the third smallest prime factor of n has size at least N α . Thus, to prove Proposition 4.1, it really does suffice to bound the sizes of the above three sets. We begin by applying the union bound, Theorem 2.1, and an upper bound sieve to deduce initial bounds for each. Lemma 4.2. There exist absolute constants 0 < α < 1 6 and 0 < γ < 1 such that #{n ∈ S(N) : 3 ∤ n, p 2 (n) > N α , and Ω(n 2 + n + 1) ≥ 3} and #{n ∈ S(N) : 3 | n, p 3 (n) > N α , and Ω(n 2 + n + 1) ≥ 3}
are both ≪ N (log N) 3 2 3 =p≤N 1 2 L(1, χ 4 ǫp p ; N γ ) 1 2 L(1, χ −3·4 ǫ −3p p ; N γ ) 1 2 p ,
where ǫ n = 0 if n ≡ 1 (mod 4) and ǫ n = 1 if n ≡ 2, 3 (mod 4), and #{n ∈ S(N) : p 1 p 2 | n for some p 1 < p 2 ≤ N α with p 1 , p 2 = 3 and Ω(n 2 + n
+ 1) ≥ 3} is ≪ N (log N) 5 4 q≤N 2 3 p 1 <p 2 ≤N α 3 =p 1 ,p 2 7 j=1 L(1, χ m j ; N γ ) k j p 1 p 2 q , where m 1 = q * , m 2 = 4 ǫp 1 p 1 , m 3 = 4 ǫp 2 p 2 , m 4 = 4 ǫp 1 p 2 p 1 p 2 , m 5 = −3 · 4 ǫ −3p 1 p 1 , m 6 = −3 · 4 ǫ −3p 2 p 2 , m 7 = −3 · 4 ǫ −3p 1 p 2 p 1 p 2 , k 1 = 1 2
, and k 2 = · · · = k 7 = 1 4 . Proof. We will apply a standard upper bound sieve, a statement of which can be found in Section 6.5 of [7], numerous times throughout this paper, including multiple times within this proof.

By Theorem 2.1 (and an application of an upper bound sieve in the second inequality), we have
#{n ∈ S(N) : 3 ∤ n, p 2 (n) > N α , and Ω(n 2 + n + 1) ≥ 3} ≤ 3 =p≤N 1 2 #S 1,p (N) + O(N 1 2 ), #{n ∈ S(N) : 3 | n, p 3 (n) > N α , and Ω(n 2 +n+1) ≥ 3} ≤ 3 =p≤N 1 2 #S 2,p (N)+O N (log N) 3 2 + N 1 2 , and that #{n ∈ S(N) : p 1 p 2 | n for some p 1 < p 2 ≤ N α with p 1 , p 2 = 3 and Ω(n 2 + n + 1) ≥ 3} is at most q≤N 2 3 p 1 <p 2 ≤N α 3 =p 1 ,p 2 #S q 3,p 1 ,p 2 (N) + O(N 1 2 ), where S 1,p (N) := n ≤ N : p | n, p 2 (n) > N α , and q | n 2 + n + 1 =⇒ p q = 1 , S 2,p (N) := n ≤ N : 3p | n, p 3 (n) > N α , and q | n 2 + n + 1 =⇒ p q = 1 , and S q 3,p 1 ,p 2 (N) equals n ≤ N : p 1 p 2 | n, q | n 2 + n + 1, and p ′ | n, q ′ | n 2 + n + 1 =⇒ p ′ q = p 1 q ′ = p 2 q ′ = 1 .
The error term O(N/(log N) 3/2 ) appearing in the second inequality comes from the contribution of n of the form n = 3 j p with p ≥ √ N , which we estimate using an upper bound sieve. The restriction that n is only divisible by large primes and 3 sieves out one congruence class modulo each prime on average (namely, the zero congruence class), and the restriction that 3 | n forces 3 q = 1 for all primes q dividing n 2 + n + 1, which sieves out half of a (nonzero) congruence class modulo each prime on average (namely, the roots of x 2 + x + 1 modulo each prime where these roots exist and for which 3 is a quadratic residue). This leads to the savings of (log N) 3/2 over the trivial bound. Similar arguments will appear numerous times throughout the remainder of this paper.

Fixing α sufficiently small, to each of S 1,p (N), S 2,p (N), and S q 3,p 1 ,p 2 (N) we apply an upper bound sieve to get that there exists a fixed constant 0 < γ ≤ α such that 5 4 when p 1 < p 2 ≤ N α with 3 = p 1 , p 2 and q ≤ N 2 3 , To finish the proof of Proposition 4.1, we require a standard lemma (which will also be used once in Section 5). 
#S 1,p (N), #S 2,p (N) ≪ N p p ′ <N γ 1 − g 1 (p ′ ) p ′ for all 3 = p ′ ≤ N 1 2 , where g 1 (p ′ ) := 1 +      2 −3 p ′ = 1 and p p ′ = −1 1 p ′ = 3 and p 3 = −1 0 otherwise and such that #S q 3,p 1 ,p 2 (N) ≪ N p 1 p 2 q p ′ <N γ 1 − g 3 (p ′ ) p ′ for all q ≤ N 2 3 and p 1 < p 2 ≤ N α with 3 = p 1 , p 2 , where g 3 (p ′ ) := 1 p ′ q = −1 0 otherwise +      2 −3 p ′ = 1 and p 1 p ′ or p 2 p ′ = −1 1 p ′ = 3 and p 1 3 or p 2 3 = −1 0 otherwise .

Standard Euler product manipulations then yield
p ′ <N γ 1 − g 1 (p ′ ) p ′ ≪ L(1, χ 4 ǫp p ; N γ ) 1 2 L(1, χ −3·4 ǫp p ; N γ ) 1 2 (log N) 3 2 when 3 = p ≤ N 1 2 and p ′ <N γ 1 − g 3 (p ′ ) p ′ ≪ 7 j=1 L(1, χ m j ; N γ ) k j (log N)L(1, χ ap ) ≪ a X log X and p 1 <p 2 ≤X p 1 ,p 2 ∤a L(1, χ ap 1 p 2 ; y) ≪ a X 2 (log X) 2 .
This lemma follows from a small modification of the argument given in Section 5 of [1] by using a mean value estimate for sums of quadratic characters over primes due to Jutila [15]. (Such a modification, in fact, gives asymptotics for the sums in Lemma 4.3, and also for higher moments.)

Now we can prove Proposition 4.1.

Proof of Proposition 4.1. By Lemma 4.2, it suffices to bound
(4.1) 3 =p≤N L(1, χ 4 ǫp 1 p 2 p 1 p 2 ; N γ ) p 1 p 2     1 4     p 1 <p 2 ≤N α 3 =p 1 ,p 2 L(1, χ −3·4 ǫ −3p 1 p 2 p 1 p 2 ; N γ ) p 1 p 2     1 4
, which is ≪ (log 2 N) 3 , also by Lemma 4.3 and partial summation.

5. n 2 + n + 1 is the product of two primes

In this section, we bound the number of n ∈ S(N) such that n 2 + n + 1 has exactly two prime factors:
Proposition 5.1. We have #{n ∈ S(N) : n 2 + n + 1 is the product of two primes} ≪ N log N exp(C log 5 N log 6 N ) for some absolute constant C > 0.
Note that n 2 < n 2 + n + 1 < (n + 1) 2 for all n ≥ 1, so that n 2 + n + 1 is never the square of a prime. As outlined in Section 2, we split the n ∈ S(N) such that n 2 + n + 1 = q 1 q 2 with q 1 < q 2 into three sets depending on the size of q 1 :
(5.1) n ∈ S(N) : n 2 + n + 1 = q 1 q 2 with q 1 < q 2 and q 1 ≤ N (log N) β (5.2) n ∈ S(N) : n 2 + n + 1 = q 1 q 2 with q 1 < q 2 and N (log N) β < q 1 ≤ N (log N) 1 2 and (5.3)
n ∈ S(N) : n 2 + n + 1 = q 1 q 2 with q 1 < q 2 and N (log N)
1 2 < q 1 ≤ N ,
for some β > 1 to be fixed shortly. To prove Proposition 5.1, it suffices to bound the size of each of the above three sets. Indeed, n 2 + n + 1 must have a prime factor of size at most N whenever n ≤ N and Ω(n 2 + n + 1) = 2, since n 2 + n + 1 < (n + 1) 2 . We begin by bounding the size of (5.1), using a modification of the argument presented in Section 4.
Lemma 5.2. There exists a β > 1 such that # n ∈ S(N) : n 2 + n + 1 = q 1 q 2 with q 1 < q 2 and q 1 ≤ N (log N) β ≪ N log N(log 2 N) 1 2 .
Proof. Arguing as in the proof of Lemma 4.2, we first note that the left-hand side of the desired inequality is bounded above by
q≤ N (log N) β #S q 4 (N) + O(N 1 2 ),
where S q 4 (N) := n ≤ N : q | n 2 + n + 1 and p | n =⇒ p q = 1 .

By an upper bound sieve, we have that
#S q 4 (N) ≪    N q log(N/q) p ′ <(N/q) γ 1 − g 4 (p ′ ) p ′ N 2 3 < q ≤ N (log N ) β N q log N p ′ <N γ 1 − g 4 (p ′ ) p ′ q ≤ N 2 3 , where g 4 (p ′ ) := 1 p ′ q = −1 0 otherwise +      2 −3 p ′ = 1 1 p ′ = 3 0 otherwise and γ > 0 is an absolute constant. Since p ′ <y 1 − g 4 (p ′ ) p ′ ≪ L(1, χ q * ; y) 1 2 (log y) 3 2
for all y > 0, it thus suffices to bound
(5.4) 1 (log N) 3 2 q≤N 2 3 L(1, χ q * ; N γ ) 1 2 q + N 2 3 <q≤ N (log N) β L(1, χ q * ; (N/q) γ ) 1 2 q(log(N/q)) 3 2 .
That the first term of (5.4) is ≪ log 2 N (log N ) 3/2 was already observed in the proof of Proposition 4.1. To remove the dependence of the number of factors in the product L(1, χ q * ; (N/q) γ ) on q in the second term, we will use that it can be well-approximated by L(1, χ q * ) for most sufficiently small q.

Indeed, set β := 64 γ . Since we have (N/q) γ ≥ (log N) 64 for all q ≤ N (log N ) β , it follows from Proposition 2.2 of [8] with A = 4 and D = N that L(1, χ q * ; (N/q) γ ) ≪ L(1, χ q * ) for all but at most N
1 2 moduli N 2 3 < q ≤ N (log N ) β .
Using the trivial bound L(1, χ; (N/q) γ ) ≪ log (N/q), the contribution to the sum (5.4) coming from these N 1 2 moduli is ≪ N − 1 6 , which is more than admissible. It thus remains to bound
N 2 3 <q≤ N (log N) β L(1, χ q * ) 1 2 q(log(N/q)) 3 2
by the positivity of L(1, χ q * ). Setting f (t) := 1 t log(N/t) 3/2 , we apply partial summation to bound the sum above by
f N (log N) β q≤ N (log N) β L(1, χ q * ) 1 2 − N (log N) β N 2 3 f ′ (t) q≤t L(1, χ q * ) 1 2 dt, which, by Lemma 4.3, is ≪ 1 log N(log 2 N) 3 2 + N (log N) β N 2 3 1 t(log t) log(N/t) 3 2 dt.
Noting that
N (log N) β N 2 3 1 t(log t) log(N/t) 3 2 dt ≪ 1 log N N (log N) β N 2 3 1 t log(N/t) 3 2 dt ≪ 1 log N(log 2 N) 1 2
completes the proof of the lemma.

Next, we bound the size of (5.2).
Lemma 5.3. We have # n ∈ S(N) : n 2 + n + 1 = q 1 q 2 with q 1 < q 2 and N (log N) β < q 1 ≤ N (log N) 1 2 ≪ β N log N exp(C log 5 N log 6 N )
, for some absolute constant C > 0.

Proof. We begin by splitting n in (5.2) up based on the smallest k = k(N) prime factors of n. Note that the size of (5.2) is at most
p 1 <···<p k ≤log 3 N #T p 1 ,...,p k (N) + #{n ≤ N : p 1 (n 2 + n + 1) ≥ N 2 3
and ω(n) < k}
+ #{n ≤ N : p 1 (n 2 + n + 1) ≥ N 2 3
, ω(n) ≥ k, and p k (n) > log 3 N}, where T p 1 ,...,p k (N) := {n ∈ S(N) : n 2 + n + 1 = q 1 q 2 with q 1 < q 2 and N (log N) β < q 1 ≤ N (log N) 1 2 , ω(n) ≥ k, and p i (n) = p i for each i = 1, . . . , k}.

The quantity #{n ≤ N : p 1 (n 2 + n + 1) ≥ N 2 3 and ω(n) < k} is bounded above by
k−1 j=1 m≤N j−1 j ω(m)=j−1 # n ≤ N m : p 1 (nm) 2 + nm + 1 ≥ N 2 3
and ω(n) = 1 , which, by an application of an upper bound sieve, is ≪ N (log N ) 2 (C log 2 N) k for some absolute constant C > 0. If k ≤ log 2 N 3 log 3 N , then the right-hand side of the above inequality is certainly ≪ N (log N ) 3/2 , which is admissible. A similar argument shows that the quantity #{n ≤ N :
p 1 (n 2 + n + 1) ≥ N 2 3 , ω(n) ≥ k, and p k (n) > log 3 N} is ≪ N (C ′ log 5 N ) k log N log 4 N for some absolute constant C ′ > 0. If k ≤ log 5 N 3 log 6 N , the right-hand side of the above inequality is ≪ N log N (log 4 N ) 1/2 ,
which is, again, admissible. So assume, for the remainder of the proof, that k = ⌊ log 5 N 3 log 6 N ⌋. It remains to bound p 1 <···<p k ≤log 3 N #T p 1 ,...,p k (N). We apply Theorem 2.1 and split each n ∈ T p 1 ,...,p k (N) up based on the prime factor q of n 2 + n + 1 lying in the interval (1) , by an application of an upper bound sieve, we have
[ N (log N ) β , N (log N ) 1/2 ] to get #T p 1 ,...,p k (N) ≤ N (log N) β ≤q≤ N (log N) 1/2 ( p i q )=1, i=1,...,k #T q p 1 ,...,p k (N) + O(N 1 2 ), where T q p 1 ,...,p k (N) := {n ∈ T p 1 ,...,p k (N) : q | n 2 + n + 1}. Since p<log 3 N p ≪ (log 2 N) 1+o#T q p 1 ,...,p k (N) ≪ N qp 1 · · · p k p<p k p =p i 1 − 1 p log k log 2 N . Summing over q ∈ [ N (log N ) β , N (log N ) 1/2 ] such that p i q = 1 for each i = 1, . . . , k yields #T p 1 ,...,p k (N) ≪ β log k 2 k 1 p 1 · · · p k p<p k p =p i 1 − 1 p N log N ,
and then summing over p 1 < · · · < p k ≤ log 3 N yields
p 1 <···<p k ≤log 3 N #T p 1 ,...,p k (N) ≪ β log k 2 k N log N p 1 <···<p k ≤log 3 N p<p k p =p i 1 − 1 p p 1 · · · p k ≪ β log k 2 k N log N ,
where for the last inequality we use the fact that
p 1 <···<p k ≤log 3 N p<p k p =p i (1− 1 p ) p 1 ···p k
is the density of integers with k prime factors below log 3 N, which, being a density, forces it to be at most 1. Recalling our choice of k now gives the conclusion of the lemma.

Finally, we bound the size of (5.3) using an enveloping sieve argument. We will require the following lattice point counting lemma, whose proof we defer to Section 7.

Lemma 5.4. There exist absolute constants C > 0 and 0 < δ 1 , δ ′ 1 < 1 such that the following holds. For all k, ℓ ≤ X δ ′ 1 with 2, 3 ∤ kℓ, we have
#{(x, y, z) ∈ Z 3 : y 2 − 4xz = −3, 1 ≤ x, z ≤ X, k | x, and ℓ | z} = Cρ ′ (kℓ) X kℓ + O(X 1−δ 1 ),
where ρ ′ is the multiplicative function defined by ρ ′ (n) := ρ(n) p|n 1 + χ −3 (p) 
(5.5) # (p 1 , p 2 ) ∈ X 1 2 , X 2 : 4p 1 p 2 − 3 is a perfect square ≪ X (log X) 2 .
Corollary 5.6. We have # n ≤ N : n 2 + n + 1 = q 1 q 2 with q 1 < q 2 and N (log N)
1 2 < q 1 ≤ N ≪ N (log N) 3 2 .
Proof. This is an immediate consequence of Lemma 5.5 with X = N(log N) 1/2 . Indeed, if n 2 + n + 1 = p 1 p 2 , then, by completing the square and multiplying through by 4, we have (2n + 1) 2 + 3 = 4p 1 p 2 . Thus, each n for which n 2 + n + 1 is the product of two primes corresponds to a pair of primes (p 1 , p 2 ) for which 4p 1 p 2 − 3 is a perfect square. If n ≤ N and p 1 ≥ N (log N ) 1/2 , then p 1 < p 2 ≤ N(log N) 1/2 , and so Lemma 5.5 applies.

Proof of Lemma 5.5. This is a straightforward application of the enveloping sieve, and our argument will be closely modeled after those given in Section 2 of [20].  
µ(k)φ log k log Y   2 .
Note that ν(p) = 1 whenever p > Y is prime. So, since ν is nonnegative, the left-hand side of (5.5) is bounded above by
(5.6) n,m≤X 2,3∤nm ν(n)ν(m)1 (4nm − 3),
where 1 denotes the indicator function of the squares. Expanding the definition of ν and applying Lemma 5.4, we get that (5.6) equals C 2 4 times
X k 1 ,k 2 ,ℓ 1 ,ℓ 2 2,3∤k 1 k 2 ℓ 1 ℓ 2 µ(k 1 )µ(k 2 )µ(ℓ 1 )µ(ℓ 2 ) [k 1 , k 2 ][ℓ 1 , ℓ 2 ] ρ ′ ([k 1 , k 2 ][ℓ 1 , ℓ 2 ])φ log k 1 log Y φ log k 2 log Y φ log ℓ 1 log Y φ log ℓ 2 log Y + O X 1−δ 1 k 1 ,k 2 ,ℓ 1 ,ℓ 2 φ log k 1 log Y φ log k 2 log Y φ log ℓ 1 log Y φ log ℓ 2 log Y .
Note that, since φ is supported on [−1, 1], the above sums over k 1 , k 2 , ℓ 1 , and ℓ 2 run over at most Y 4 ≤ X δ 1 2 quadruples of integers. Thus, the error term is ≪ φ X 1− δ 1 2 . We now focus on the main term. As in the proof of Proposition 2.1 in [20], we apply Fourier inversion to write
e t φ(t) = ∞ −∞ ψ(u)e −itu du
for ψ rapidly decaying. It then follows, by the rapid decay of ψ, that
φ log k log Y = |u|≤(log Y ) 1/2 ψ(u) k 1+iu log Y du + O k − 1 log Y (log Y ) 10
for any k ≥ 1, so that the main term of our expression for (5.6) equals
C 2 4 X |u i |≤(log Y ) 1/2 4 i=1 ψ(u i )     k 1 ,k 2 ,ℓ 1 ,ℓ 2 2,3∤k 1 k 2 ℓ 1 ℓ 2 µ(k 1 )µ(k 2 )µ(ℓ 1 )µ(ℓ 2 )ρ ′ ([k 1 , k 2 ][ℓ 1 , ℓ 2 ]) [k 1 , k 2 ][ℓ 1 , ℓ 2 ]k 1+iu 1 log Y 1 k 1+iu 2 log Y 2 ℓ 1+iu 3 log Y 1 ℓ 1+iu 4 log Y 2     du 1 du 2 du 3 du 4 ,
plus an error term that is O( X (log N ) 6 ). By Hensel's lemma, ρ ′ evaluated at any integer k with 2, 3 ∤ k equals ρ ′ evaluated at the squarefree part of k. Thus, the quantity inside of the brackets above can be expressed as the Euler product
p>3 1− ρ ′ (p) p 1+ (1+iu 1 ) log Y − ρ ′ (p) p 1+ (1+iu 2 ) log Y − ρ ′ (p) p 1+ (1+iu 3 ) log Y − ρ ′ (p) p 1+ (1+iu 4 ) log Y + ρ ′ (p) p 1+ 2+iu 1 +iu 2 log Y + ρ ′ (p) p 1+ 2+iu 3 +iu 4 log Y + ρ ′ (p) p 2+ 2+iu 1 +iu 3 log Y + ρ ′ (p) p 2+ 2+iu 1 +iu 4 log Y + ρ ′ (p) p 2+ 2+iu 2 +iu 3 log Y + ρ ′ (p) p 2+ 2+iu 2 +iu 4 log Y − ρ ′ (p) p 2+ 3+iu 1 +iu 2 +iu 3 log Y − ρ ′ (p) p 2+ 3+iu 1 +iu 2 +iu 4 log Y − ρ ′ (p) p 2+ 3+iu 1 +iu 3 +iu 4 log Y − ρ ′ (p) p 2+ 3+iu 2 +iu 3 +iu 4 log Y + ρ ′ (p) p 2+ 4+iu 1 +iu 2 +iu 3 +iu 4 log Y .
Letting L(s) := n µ(n)ρ ′ (n) n s denote the Dirichlet series for µ · ρ ′ , this Euler product equals
(5.7) L(1 + (1+iu 1 ) log Y )L(1 + (1+iu 2 ) log Y )L(1 + (1+iu 3 ) log Y )L(1 + (1+iu 4 ) log Y ) L(1 + 2+iu 1 +iu 2 log Y )L(1 + 2+iu 3 +iu 4 log Y ) C ′ + O 1 + 4 i=1 |u i | log Y for some absolute constant C ′ > 0.
Note that, by the definition of ρ ′ , we have 
L(s) = p>3 1 − 1 + χ −3 (p) p s + p s−1 = p>3 1 − 1 + χ −3 (p) p s − 1 + χ −3 (p) p 2s+1 + p s ,c 2 ρ ′ (log Y ) 2 · (1 + iu 1 )(1 + iu 2 )(1 + iu 3 )(1 + iu 4 ) (2 + iu 1 + iu 2 )(2 + iu 3 + iu 4 ) C ′ + O 1 (log Y ) 1/2 .
The main term of our expression for (5.6) thus equals
(Cc ρ ′ ) 2 C ′ 4 · X (log Y ) 2 |u i |≤(log Y ) 1/2 4 i=1 ψ(u i ) (1 + iu 1 )(1 + iu 2 )(1 + iu 3 )(1 + iu 4 ) (2 + iu 1 + iu 2 )(2 + iu 3 + iu 4 ) du 1 du 2 du 3 du 4 + O    X (log Y ) 5/2 |u i |≤(log Y ) 1/2 4 i=1 |ψ(u i )| (1 + |u 1 |)(1 + |u 2 |)(1 + |u 3 |)(1 + |u 4 |) (2 + |u 1 | + |u 2 |)(2 + |u 3 | + |u 4 |) du 1 du 2 du 3 du 4    .
The error term is ≪ X (log Y ) 5/2−ε since ψ is rapidly decaying, and, by extending the integral in the main term to all of R 4 using the rapid decay of ψ, the main term equals
(Cc ρ ′ ) 2 C ′ 4 · X (log Y ) 2 ∞ −∞ ∞ −∞ ψ(u 1 )ψ(u 2 ) (1 + iu 1 )(1 + iu 2 ) (2 + iu 1 + iu 2 ) du 1 du 2 2 ,
plus an error that is O( X (log Y ) 10 ), say. The above quantity equals (Cc ρ ′ ) 2 C ′ 4 · X (log Y ) 2 , since the double integral equals 1 (see the manipulation at the end of the proof of Proposition 2.2 of [20]). The conclusion of the lemma now follows from our choice of Y . Proposition 5.1 is now an immediate consequence of Lemmas 5.2 and 5.3 and Corollary 5.6.


n 2 + n + 1 is prime

In this section, we bound the number of n ∈ S(N) such that n 2 + n + 1 is prime: Proposition 6.1. We have #{n ∈ S(N) : n 2 + n + 1 is prime} ≪ N log N exp(C log 5 N log 6 N ) for some absolute constant C > 0.

The number of n ∈ S(N) such that n 2 + n + 1 is a prime that is congruent to 3 modulo 4 is easy to bound. Lemma 6.2. We have #{n ∈ S(N) : n 2 + n + 1 is prime and congruent to 3 (mod 4)} ≪ N (log N) 3 2 .

Proof. By quadratic reciprocity, we have that if p | n is odd and n 2 + n + 1 ≡ 3 (mod 4) is prime, then p n 2 +n+1 = (−1)
p−1 2 n 2 +n+1 p = (−1) p−1 2 .
Thus, by Theorem 2.1, we have that the number of n ∈ S(N) such that n 2 + n + 1 is a prime that is congruent to 3 modulo 4 is at most #{n ≤ N : Ω(n 2 + n + 1) = 1 and 2 = p | n =⇒ p ≡ 1 (mod 4)} + O(N 1 2 ). The first term above is ≪ N (log N ) 3/2 by an upper bound sieve. It now remains to deal with n ∈ S(N) such that n 2 + n + 1 is a prime that is congruent to 1 modulo 4. As outlined in Section 2, to finish our proof of Theorem 1.2, we will combine Lemma 2.2 with the quartic reciprocity law to reduce the problem of bounding the number of such n to that of bounding the number of certain representations of prime values of n 2 + n + 1 by the quadratic form x 2 + y 2 . This can be done using the Selberg sieve as long as we have a sufficiently accurate count for the number of lattice points on the hyperboloid 4x 2 + 16y 2 − z 2 = 3 with y and z satisfying a variety of congruence restrictions and |z| ≤ 2N + 1.

We first state the quartic reciprocity law and the required lattice point counting lemma, whose proof we defer to Section 8. Theorem 6.3 (Quartic reciprocity). Let q ≡ 1 (mod 4) and p be primes satisfying q p = 1 and let σ be a root of the congruence q ≡ σ 2 (mod p). Assume that q = x 2 + y 2 with 2 | y. Then p * q 4 = σ(σ + y) p .

(See Theorem 5.5 of [16].) As it will be relevant in the proof of Lemma 6.5 below, note that in the situation of Theorem 6.3, we must have σ(σ+y) p = σ(σ−y) p . Lemma 6.4. There exist absolute constants C > 0 and 0 < δ 2 , δ ′ 2 < 1 such that the following holds. Let p 1 , . . . , p k ≤ log 3 N and q 1 , . . . , q m ≤ log 3 N be disjoint collections of primes. For all odd squarefree ℓ ≤ X δ ′ 2 with p 1 · · · p k q 1 · · · q m | ℓ and for all congruence classes a (mod p 1 · · · p k ) and b (mod 8ℓ) satisfying
(1) 1+2a p i = 1−2a p i for each i = 1, . . . , k, (2) b ≡ 1 (mod 2p i ) for each i = 1, . . . , k,(3)
b ≡ 1 (mod 2q j ) for each j = 1, . . . , m, and (4) b 2 ≡ −3 (mod r), where r := ℓ p 1 ···p k q 1 ···qm , we have #{(x, y, z) ∈ Z 3 :4x 2 + 16y 2 − z 2 = 3, |z| ≤ X, y ≡ a (mod p 1 · · · p k ), and z ≡ b (mod 8ℓ)}
= C2 k k i=1 w 1 (a, p i ) m j=1 w 2 (q j ) p|r w 3 (p) X (p 1 · · · p k ) 2 q 1 · · · q m r + O(X 1−δ 2 ),
where w 1 (a, p) = (1 + χ 12 (p))
δ 1 4 (a (mod p)) 1 − χ 12 (p) p 1 − 1 p 2 , w 2 (p) := 1 + 2χ 12 (p) − 1 p 1 − χ 12 (p) p 1 − 1 p 2 , and w 3 (p) := (1 + χ −1 (p)) 1 + 2χ 12 (p) − 1 2p 1 − χ 12 (p) p 1 − 1 p 2 .
Now we can bound the number of n ∈ S(N) such that n 2 + n + 1 is a prime that is congruent to 1 modulo 4. Proof. The proof begins in the same manner as the proof of Lemma 5.3. We split n up based on the smallest k = k(N) prime factors of n to get that the size of the set in question is at most
p 1 <···<p k ≤log 3 N #T p 1 ,...,p k (N)
+ #{n ≤ N : n 2 + n + 1 is prime and ω(n) < k} + #{n ≤ N : n 2 + n + 1 is prime, ω(n) ≥ k, and p k (n) > log 3 N}, where T p 1 ,...,p k (N) := {n ∈ S(N) : n 2 +n+1 ≡ 1 (mod 4) is prime, ω(n) ≥ k, and p i (n) = p i for i = 1, . . . , k}.

By the argument in the proof of Lemma 4.2, by setting k = ⌊ log 5 N 3 log 6 N ⌋ we get that the sizes of the two sets above are ≪ Applying Theorem 6.3 with q = n 2 + n + 1 for n ∈ T ′ p 1 ,...,p k (N) and σ = 1 gives p i n 2 + n + 1 4 = (−1) = −1) modulo p i . We will show that
(6.1) #T ′ p 1 ,...,p k ;a,j (N) ≪ 2 k log k k i=1 w 1 (a i , p i ) p<p k p =p i 1 − 1 p N (p 1 · · · p k ) 2 log N ,
where T ′ p 1 ,...,p k ;a,j (N) := {n ≤ N : n 2 + n + 1 prime, n ≡ j (mod 8), p i (n) = p i for i = 1, . . . , k, and n 2 + n + 1 = x 2 + 4y 2 with y ≡ a i (mod p i ) for i = 1, . . . , k} for such a = (a 1 , . . . , a k ) and j = 0, 3, 4, 7. For each n ∈ N, set m a (n) := #{(x, y) ∈ Z 2 : n 2 + n + 1 = x 2 + 4y 2 with y ≡ a i (mod p i ) for i = 1, . . . , k},
so that #T ′ p 1 ,...,p k ;a,j (N) ≪ n≤N n 2 +n+1 prime n≡j (mod 8) p i (n)=p i for i=1,...,k m a (n).
For each r ∈ N and congruence class b (mod r), also set Note that, if n 2 + n + 1 = x 2 + 4y 2 , then, by completing the square, we have that 4x 2 + 16y 2 − (2n + 1) 2 = 3 . So, by applying Lemma 6.4 when r ≤ N δ ′ 2 2 is odd, squarefree, and satisfies (p 1 · · · p k , r) = 1 and b (mod r) satisfies b 2 ≡ −3 (mod r), we have that
M a,j (r) = C2 k k j=1 w 1 (a j , p j ) p<p k p =p j 1 − w 2 (p) p p|r w 3 (p) N (p 1 · · · p k ) 2 r + O N 1−δ 2
for each choice of a = (a 1 , . . . , a k ) where 1 + 2a i and 1 − 2a i are both quadratic residues or nonresidues (depending on j and p i ) modulo p i for i = 1, . . . , k. Because of the power-saving error term above, we can apply the Selberg sieve to deduce (using that w 2 (p) = 1 + O(p −1 ) and w 3 (p) = 1 + χ −1 (p) + O(p −1 )) the desired bound (6.1) for each #T ′ p 1 ,...,p k ;a,j (N). Now, we sum over all admissible choices of a. There are at most p i +O(1) 4 possible choices of a i (mod p i ) for each p i > 2 (by considering either the number of points on the conic x 2 + y 2 = 2 modulo p i or the number of points on the conic x 2 + y 2 = −2 modulo p i , since, for example, any a for which 1 + 2a = y 2 and 1 − 2a = x 2 in Z/pZ gives rise to a solution to x 2 + y 2 = 2 modulo p). We thus have
a (mod p i ) 1−2a p i = 1+2a p i =(−1) p i −1 2 · j 2 +j 4 w 1 (a, p i ) p 2 i = 1 4p i + O 1 p 2 i ,
so, by the Chinese remainder theorem, we get that
#T ′ p 1 ,...,p k (N) ≪ log k 2 k 1 p 1 · · · p k p<p k p =p i 1 − 1 p N log N ,
and are in exactly the same situation as in the end of the proof of Lemma 5.3. Summing over p 1 < · · · < p k ≤ log 3 N as in that argument yields the desired bound for the number of n ∈ S(N) such that n 2 + n + 1 is a prime that is congruent to 1 modulo 4. Proposition 6.1 now follows from Lemmas 6.2 and 6.5, and Theorem 1.2 follows from Propositions 4.1, 5.1, and 6.1.


The first lattice point count

In this section, we prove Lemma 5.4, the first of our two lattice point counting results. We do this by adapting an argument of Hooley [12], incorporating a bound of Duke, Friedlander, and Iwaniec [4] in place of Hooley's bound for weighted averages of sums of additive characters over roots of quadratic congruences. For the convenience of the reader, we record Duke, Friedlander, and Iwaniec's result specialized to the case we will use.  
1 [ X ℓ ] y 2 + 3 4ℓx .
Splitting y up based on its congruence class modulo 4ℓx, the above equals
x≤X k|x ν 2 ≡−3 (mod 4ℓx) 0<ν≤4ℓx y≡ν (mod 4ℓx) 1 [ X ℓ ] y 2 + 3 4ℓx .
Note that y 2 +3 4ℓx ≤ X ℓ if and only if |y| ≤ √ 4xX − 3. Letting ψ(u) := ⌊u⌋ − u + 1 2 denote the sawtooth function, it thus follows that
y≡ν (mod 4ℓx) 1 [ X ℓ ] y 2 + 3 4ℓx = 2 · #{y ∈ [ √ 4xX − 3] : y ≡ ν (mod 4ℓx)} = 2 √ 4xX − 3 − ν 4ℓx − −ν 4ℓx = 2 √ 4xX − 3 4ℓx + ψ √ 4xX − 3 − ν 4ℓx − ψ −ν 4ℓx . Thus, since √ 4xX − 3 = 2 √ xX + O 1 √ xX , our desired count equals (7.1) 2 x≤X k|x ν 2 ≡−3 (mod 4ℓx) 0<ν≤4ℓx X 1 2 2ℓx 1 2 + ψ √ 4xX − 3 − ν 4ℓx − ψ −ν 4ℓx + O(log X).
We first deal with the main term of (7.1):
X 1 2 ℓ x≤X k|x ρ(4ℓx) x 1 2 .
Note that we can write x≤X k|x ρ(4ℓx)
x 1/2 = 2ℓ 1 2 x≤4ℓX 4kℓ|x ρ(x) x 1/2 . So, set L(s) := a≡0 (mod 4kℓ) ρ(a) a s
for ℜ(s) > 1. It is shown in Subsection 12.1 of [5] (the restriction there that D > 0 is unnecessary for the relevant computation) that
L(s) = ζ(s)L(s, χ −3 ) ζ(2s) ρ(4kℓ) (4kℓ) s p|kℓ 1 + χ −3 (p) p s −1 ,
so that L(s) is holomorphic for ℜ(s) ≥ 1/2 aside from a simple pole at s = 1, where it has residue 6 π 2 L(1, χ −3 )
ρ(4kℓ) 4kℓ p|kℓ 1 + χ −3 (p) p −1 .
By partial summation, we have x≤4ℓX 4kℓ|x

ρ(x)
x 1 2 = 1 (4ℓX) 1 2 x≤4ℓX 4kℓ|x ρ(x) + 1 2 4ℓX 1 t − 3 2 x≤t 4kℓ|x ρ(x)dt,
while, by a standard contour integration, we also have that x≤t 4kℓ|x
ρ(x) = 6 π 2 L(1, χ −3 ) ρ(4kℓ) 4kℓ p|kℓ 1 + χ −3 (p) p −1 t + O(t 3 4 +ε ).
So, x≤X 4kℓ|x

ρ(x)
x 1 2 = C ρ ′ (kℓ) 2kℓ 1 2 X 1 2 + O(X 1 4 +ε )
for some absolute constant C > 0. Thus, the main term in (7.1) equals C ρ ′ (kℓ) kℓ X + O(X 3 4 +ε ). Now we can deal with the error term of (7.1):
2 x≤X k|x ν 2 ≡−3 (mod 4ℓx) 0<ν≤4ℓx ψ √ 4xX − 3 − ν 4ℓx − 2 x≤X k|x ν 2 ≡−3 (mod 4ℓx) 0<ν≤4ℓx ψ −ν 4ℓx .
Arguing as in Section 5 of [12], we use the Fourier expansion of ψ to write
ψ(u) = 1 π M h=1 sin(2πhu) h + O min 1, 1 M u for some 1 ≤ M ≤ X 1 2
to be chosen later, so that the two sums appearing in the error term equal
1 π M h=1 x≤X k|x ν 2 ≡−3 (mod 4ℓx) 0<ν≤4ℓx sin(2πh √ 4xX−3−ν 4ℓx ) h +O     x≤X k|x ν 2 ≡−3 (mod 4ℓx) 0<ν≤4ℓx min 1, 1 M √ 4xX−3−ν 4ℓx     and 1 π M h=1 x≤X k|x ν 2 ≡−3 (mod 4ℓx) 0<ν≤4ℓx sin(2πh −ν 4ℓx ) h + O     x≤X k|x ν 2 ≡−3 (mod 4ℓx) 0<ν≤4ℓx min 1, 1 M −ν 4ℓx     .
To estimate the main term of the first sum, we use the sine addition law to write it as
1 π M h=1 x≤X k|x ν 2 ≡−3 (mod 4ℓx) 0<ν≤4ℓx sin(2πh √ 4xX−3 4ℓx ) cos(2πh ν 4ℓx ) − cos(2πh √ 4xX−3 4ℓx ) sin(2πh ν 4ℓx ) h .
Using that ν 2 ≡−3 (mod 4ℓx) 0<ν≤4ℓx cos 2πh ν 4ℓx = ν 2 ≡−3 (mod 4ℓx) 0<ν≤4ℓx e h ν 4ℓx and sin(−t) = − sin(t), the expression above equals
(7.2) 1 π M h=1 1 h x≤X k|x sin 2πh √ 4xX − 3 4ℓx ν 2 ≡−3 (mod 4ℓx) 0<ν≤4ℓx e h ν 4ℓx .
To estimate the error term of the first sum, we use the Fourier expansion of the function u → min 1, 1 M u given in Section 5 of [12] combined with the cosine addition law to write the sum inside of the big-O as
(7.3) 1 2 C 0 (M) x≤X k|x ρ(4ℓx) + ∞ h=1 C h (M) x≤X k|X cos 2πh √ 4xX − 3 4ℓx ν 2 ≡−3 (mod 4ℓx) 0<ν≤4ℓx e h ν 4ℓx , where C h (M) ≪ log M M for all h ≥ 0 and C h (M) ≪ M h 2 for all h ≥ 1.
The main term of the expression for the second sum in the error term of (7.1) vanishes, and the quantity inside of the error term can, similarly to above, be written as
(7.4) 1 2 C 0 (M) x≤X k|x ρ(4ℓx) + ∞ h=1 C h (M) x≤X k|X ν 2 ≡−3 (mod 4ℓx) 0<ν≤4ℓx e h ν 4ℓx .
Now we bound (7.2), (7.3), and (7.4), starting with the portions of the sums that can be bounded trivially. Take M = X 1/1000 . The contribution to (7.2) coming from x ≤ X 99/100 is ≪ ε ℓ ε X 99/100+ε . The contribution to (7.3) and (7.4) coming from h ≥ δX is ≪ ε MX ε /δ ≪ ε X 1/1000+ε /δ, and the contribution to the second sum in (7.3) and (7.4) coming from x ≤ X 99/100 is ≪ ε MX 99/100+ε ≪ ε X 991/1000+ε .

To bound the remainder of (7.2), (7.3), and (7.4), we will apply Proposition 7.1 on dyadic intervals. Fix a smooth function φ : R → [0, 1] supported on [4,8] with φ(t) = 1 for x ∈ [5,7] that decreases to 0 on [4,5] and [7,8]. For any Y > 0, define  
φ Y (t) := X −12/200 φ(4t/Y ), so that φ Y : R → [0, X −12/200 ] is supported on [Y,φ (i) Y (t) ≤ X −12/200 4 Y i max t ′ ∈[4,8] φ (i) (t ′ ) ≪ X −12/200 Y −i for all t ∈ [Y,− 3) 1/2 /t)φ Y i (t), cos(2πh( tX ℓ − 3) 1/2 /t)φ Y i (t), and φ Y i (t).
The third choice of f obviously satisfies the derivatives condition in Proposition 7.1, and the other two do as well as long as h ≤ X 1/100 . This gives a bound of ≪ ε ℓ ε X 3/4+12/200+ε for the contribution of x ≥ X 99/100 to (7.2) and a bound of ≪ ε (kℓ) ε ( X log M M + X 3/4+12/200+ε ) ≪ ε (kℓ) ε X 999/1000+ε for the contribution of h ≤ X 1/100 and x ≥ X 99/100 /2 to (7.3) and (7.4). Combining these bounds with the trivial contributions from the previous paragraph (choosing δ = X −99/100 ), we conclude that the error term of (7.1) is ≪ (kℓ) ε X 999/1000+ε , completing the proof of the lemma.


The second lattice point count

We will prove Lemma 6.4 following the same strategy as the proof of Lemma 5.4, with two key differences. The first stems from the fact that these two lemmas concern different hyperboloids, and so a change of variables is needed before the hyperboloid in Lemma 6.4 can be analyzed in a similar manner to the hyperboloid in Lemma 5.4, which introduces additional complications. The second is that there is not, currently in the literature, any analogue of Proposition 7.1 that can be applied to the situation of Lemma 6.4. We will prove such a result from scratch in Lemma 8.2, adapting an argument of Hooley from Section 6 of [12]. One of the ingredients of this proof is the following classical lemma, which connects roots of quadratic congruences to representations by quadratic forms.
Lemma 8.1.
(1) Let n ∈ N. There is a bijective correspondence between solutions ν ∈ Z/nZ to the congruence ν 2 ≡ 3 (mod n) and equivalence classes of primitive representations of n by the quadratic form x 2 − 3y 2 {ν (mod n) : ν 2 ≡ 3 (mod n)} ↔ (r, s) ∈ Z 2 : n = r 2 − 3s 2 / ∼, where (r, s) ∼ (r ′ , s ′ ) if r ′ = ar + bs and s ′ = cr + ds for some ( a b c d ) ∈ Aut x 2 −3y 2 (Z), given by
ν = rρ − 3sσ ↔ n = r 2 − 3s 2 , where rσ − sρ = 1. In this situation, we have ν n ≡ − s r r − 3s r(r 2 − 3s 2 ) (mod 1),
where s r denotes the multiplicative inverse of s modulo r. In each equivalence class of ∼, there is exactly one representation n = r 2 − 3s 2 with r, s > 0 and s ≤ r 2 .

(2) Let n, m ∈ N with gcd(n, m) = 1. Suppose that n = a 2 − 3b 2 and m = r 2 − 3s 2 are primitive representations of n and m, respectively, and that (ar +3bs)σ −(as+br)ρ = 1. Then ν := (ar + 3bs)ρ − 3(as + br)σ satisfies
ν n ≡ − b a a − 3b a(a 2 − 3b 2 ) (mod 1).
Proof. The proof of the first statement can be found in [19,Art. 86 and Art. 100], but we include an argument here as well. Since every binary quadratic form of discriminant 12 is equivalent to x 2 − 3y 2 , for every 0 < ν ≤ n satisfying ν 2 ≡ 3 (mod n), there exists ( r ρ s σ ) ∈ SL 2 (Z) such that g(rx + ρy, sx + σy) = x 2 − 3y 2 , where g(x, y) is the form g(x, y) := nx 2 + 2νsy + ν 2 − 3 n y 2 .

(Further, the set of such ( r ρ s σ ) is a coset of Aut x 2 −3y 2 (Z) in SL 2 (Z).) In this situation, we must have n = r 2 − 3s 2 and ν = rρ − sσ. That there is exactly one such matrix ( r ρ s σ ) satisfying r, s > 0 and s ≤ r 2 follows from the fact that 2 + √ 3 is a fundamental unit of O Q( √ 3) , and the expression for ν n follows from a straightforward manipulation. The second statement follows immediately from the fact that, whenever ℓ = t 2 − 3u 2 for gcd(t, u) = 1 and tσ ′ − uρ ′ = tσ ′′ − uρ ′′ = 1, we have that tρ ′ − 3uσ ′ ≡ tρ ′′ − 3uσ ′′ (mod ℓ). Indeed, note that the condition (ar + 3bs)σ − (as + br)ρ = 1 implies that a(rσ − sρ) − b(rρ − 3sσ) = 1 and the definition of ν can be rewritten as ν = a(rρ − 3sσ) − 3b(rσ − sρ).

We now argue along the lines of Section 6 of [12] to prove the following lemma.

Lemma 8.2. There exists an absolute constant 0 < γ < 1 such that the following holds. For every |h|, |h ′ | ≤ X γ , k, ℓ ≤ X γ relatively prime with ℓ 0 := rad(ℓ), 0 < d < k with gcd(d, k) = 1, and 0 < w < ℓ 0 with gcd(w, ℓ 0 ) = 1, we have that
u≤X u≡d (mod k) u≡ℓw (mod ℓ 0 ℓ) ν 2 ≡3 (mod ℓ 0 u) 0<ν≤ℓ 0 u e h νk ℓ 0 u e h ′ ν ℓ 0 ≪ X 5 6
and u≤X u≡d (mod k) u≡ℓw (mod ℓ 0 ℓ) e ±h u(2X − u) + 3 kℓ 0 u
ν 2 ≡3 (mod ℓ 0 u) 0<ν≤ℓ 0 u e h νk ℓ 0 u e h ′ ν ℓ 0 ≪ X 5 6 ,
where k denotes the multiplicative inverse of k modulo ℓ 0 u.

Proof. Since gcd(ℓ 0 d, k) = 1, there exist integers w and v such that wk − vℓ 0 d = 1. Then k ≡ v ℓ 0 u−ℓ 0 d k + w (mod ℓ 0 u) whenever u ≡ d (mod k), so we may rewrite the above two sums as
(8.1) u≤X u≡d (mod k) u≡ℓw (mod ℓ 0 ℓ) ν 2 ≡3 (mod ℓ 0 u) 0<ν≤ℓ 0 u e h ν v ℓ 0 u−ℓ 0 d k + w ℓ 0 u e h ′ ν ℓ 0 and (8.2) u≤X u≡d (mod k) u≡ℓw (mod ℓ 0 ℓ) e ±h (2X − u) 1 2 kℓ 0 u 1 2 ν 2 ≡3 (mod ℓ 0 u) 0<ν≤ℓ 0 u e h ν v ℓ 0 u−ℓ 0 d k + w ℓ 0 u e h ′ ν ℓ 0
plus a quantity that is O(1). Using Lemma 8.1 with n = ℓ 0 ℓ and m = u ℓ , which are coprime, and using the 1-1 correspondence between solutions ν 2 ≡ 3 (mod nm) and pairs of solutions ν 2 1 ≡ 3 (mod n) and ν 2 2 ≡ 3 (mod m), we can write (8.1) and (8.2) as the sum over ≪ X 2γ pairs of integers a, b satisfying ℓ 0 ℓ = a 2 − 3b 2 , b ≤ a 2 , gcd(a, b) = 1, and 0 < a, b < X γ of the phase
e h ′ − ba a − 3b a(a 2 −3b 2 ) times the quantities (8.3) b 1 ,b 2 (mod ℓ 0 k) b 2 1 −3b 2 2 ≡ℓd (mod k) b 2 1 −3b 2 2 ≡w (mod ℓ 0 ) r 2 −3s 2 ≤ X ℓ 0 ℓ 0<s≤ r 2
r≡b 1 (mod ℓ 0 k) s≡b 2 (mod ℓ 0 k) gcd(ar+3bs,as+br)=1 ψ 1 (ar+3bs, as+br)e −h as + br ar+3bs ar + 3bs
vℓ 0 (r 2 − 3s 2 )ℓ − d k + w and (8.4) b 1 ,b 2 (mod ℓ 0 k) b 2 1 −3b 2 2 ≡ℓd (mod k) b 2 1 −3b 2 2 ≡w (mod ℓ 0 ) r 2 −3s 2 ≤ X ℓ 0 ℓ 0<s≤ r 2 r≡b 1 (mod ℓ 0 k) s≡b 2 (mod ℓ 0 k) gcd(ar+3bs,as+br)=1
ψ 2 (ar+3bs, as+br)e −h as + br ar+3bs ar + 3bs vℓ 0 (r 2 − 3s 2 )ℓ − d k + w , respectively, where
ψ 1 (θ, µ) := e −h 3µ θ(θ 2 − 3µ 2 ) v θ 2 − 3µ 2 − ℓ 0 d k + w and ψ 2 (θ, µ) := e h ± (2X − θ 2 −3µ 2 ℓ 0 ) 1 2 kℓ 1 2 0 (θ 2 − 3µ 2 ) 1 2 − 3µ θ(θ 2 − 3µ 2 ) v θ 2 − 3µ 2 − ℓ 0 d k + w .
For each possible value of c := ar+3bs and each pair (b 1 , b 2 ) (mod ℓ 0 k) satisfying b 2 1 −3b 2 2 ≡ ℓd (mod k) and b 2 1 − 3b 2 2 ≡ w (mod ℓ 0 ), we will bound the inner sums over the values of  e −h as + br c c v c 2 − 3(as + br) 2 − ℓ 0 d k + w .
                   r 2 − 3s 2 ≤ X ℓ 0 ℓ 0 < s ≤ r 2 ar + 3bs = c r ≡ b 1 (mod ℓ 0 k) s ≡ b 2 (mod ℓ 0 k) gcd(c,
Note that |ψ 1 |, |ψ 2 | ≤ 1, and
|ψ 1 (c, t) − ψ 1 (c, t + 1))| ≪ X O(γ) c and |ψ 2 (c, t) − ψ 2 (c, t + 1))| ≪ X 1 2 +O(γ) c 2 + X O(γ) c when t ≤ M.
To deduce a bound for g c (t), we start by writing c = ℓ 0 kn 1 + c 1 and as + br = ℓ 0 kn 2 + c 2 in the definition of g c (t) with c 1 := ab 1 + 3bb 2 and c 2 := ab 2 + bb 1 , so that g c (t) = ℓ 0 kn 2 +c 2 =as+br≤t (8.7) e c −h(ℓ 0 kn 2 + c 2 ) c · v ℓ 2 0 k(n 2 1 − 3n 2 2 ) + 2ℓ 0 (c 1 n 1 − 3c 2 n 2 ) + w ′ plus a quantity that is O(X 1−δ 2 ), for every a (mod 2ℓ) that satisfies 2a+1
q j 1−2a q j = −1
for each j = 1, . . . , m, for then we can just sum over all 2r m j=1 q j +1 2 of the possible values of a modulo 2rq 1 · · · q m .

To estimate (8.8), we make the change of variables u → z−4y and v → z+4y to write (8.8) as 4 times the quantity
#{(x, u, v) ∈ Z 3 : 4x 2 −uv = 3, u ∈ [X], v ∈ [2X−u], u ≡ b−4a (mod 8ℓ), v ≡ b+4a (mod 8ℓ)},
which, setting ℓ 0 := gcd(ℓ, b − 4a) and k := 8ℓ ℓ 0 and using hypotheses (1), (2), (3), and (4) of the statement of the lemma and our choice of a (mod 2ℓ), we can write as the sum of
(8.9) 2 k+m m j=1 1 2 δ ± 1 2 (a (mod q j )) · p|r 1 + χ −1 (p) 2 δ 0 (a (mod p))
quantities of the form
2 u≤X u≡b−4a (mod 8ℓ) 4ν 2 ≡3 (mod ℓ 0 u) 0<ν≤ℓ 0 u x≡ν ′ (mod ℓ 0 u) x≡c (mod k) 1 [2X−u] 4x 2 − 3 u for ν ′ ≡ ν + 8ν(b + 4a)P u (mod ℓ 0 u),
where P u ≡ p e (mod p e+1 ) for each p e u with p | ℓ and P u ≡ 0 (mod p e ) for each p e u with p ∤ 8ℓ, and some c (mod k). As in the proof of Lemma 5.4, the sum above equals (8.10)
u≤X u≡b−4a (mod 8ℓ) 4ν 2 ≡3 (mod ℓ 0 u) 0<ν≤ℓ 0 u (2X − u) 1 2 16ℓu 1 2 + ψ √ 2uX − u 2 + 3 − ν k 16ℓu − ψ −ν k 16ℓu
plus a quantity that is O(log X), where
ν k = ν ′ · k ℓ 0 u k + c · ℓ 0 (b − 4a) k ℓ 0 u.
(Here k ℓ 0 u denotes the multiplicative inverse of k modulo ℓ 0 u and, similarly, ℓ 0 (b − 4a) k denotes the multiplicative inverse of ℓ 0 (b − 4a) modulo k.) We first deal with the main term of (8.10), which, by Hensel's lemma, equals 1 16ℓ
u≤X u≡b−4a (mod 8ℓ) ρ ′′ (ℓ 0 u)(2X − u) 1 2 u 1 2 ,
where ρ ′′ (n) := #{ν (mod n) : 4ν 2 ≡ 3 (mod n)}. The treatment of this quantity is similar to the treatment of the main term of (7.1), except that we will need to derive expressions ourselves for the Dirichlet series χ(ℓ 0 )ℓ s 0 L χ (s), where L χ (s) := ℓ 2 0 |n ρ ′′ (n)χ(n) n s , for each Dirichlet character χ modulo k. We do this by computing the local factors of these Dirichlet series.

For p = 3, we have the local factor 1 + χ (3) Noting that p i | ℓ 0 if and only if a ≡ 1 4 (mod p i ) and q j | ℓ 0 if and only if a ≡ 1 4 (mod q j ), we get the promised main term in the statement of Lemma 6.4 by multiplying by (8.9) and summing over the possible choices of a modulo 2rq 1 · · · q m .

We must now bound the error term of (8.10):
u≤X u≡b−4a (mod 8ℓ) 4ν 2 ≡3 (mod ℓ 0 u) 0<ν≤ℓ 0 u ψ u(2X − u) + 3 − ν k 16ℓu − u≤X u≡b−4a (mod 8ℓ) 4ν 2 ≡3 (mod ℓ 0 u) 0<ν≤ℓ 0 u ψ −ν k 16ℓu .
Let r 1 . . . r d = ℓ 0 be the prime factorization of ℓ 0 . To deal with the dependence of P u on u, we will split these sums over u up based on the d-tuple (e 1 , . . . , e d ) for which r e 1 1 · · · r e d d u and the congruence class of 
4ν 2 ≡3 (mod ℓ 0 u) 0<ν≤ℓ 0 u ψ u(2X − u) + 3 − ν k 16ℓu +O(X 1−2δ ′ 2 +ε ),
(since any u with r e 1 1 · · · r e d d u for some r e 1 1 · · · r e d d > X 4δ ′ 2 must be divisible by one of at most (log X 4δ ′ 2 ) d many integers of size at least X 4δ ′ 2 , where d ≤ log ℓ log 2 ℓ ≤ 2δ ′ 2 log X log 2 X , so that (log X 4δ ′ 2 ) d ≪ X 2δ ′ 2 ) and, similarly, the second sum above as Just like in the proof of Lemma 5.4, we will insert the Fourier expansion for the sawtooth function to deal with each of the above inner sums over u. For every 1 ≤ M ≤ X 1 2 , we get that the first inner sum over u above can be written as the sum of
1 π M h=1 1 h cos 2πh c · ℓ 0 (b − 4a) k 2k E 1 (h),
where E 1 (h) equals plus an error term that is at most an absolute constant times ρ ′′ (u) and, similarly, the second inner sum over u above can be written as
∞ h=1 C h (M) cos 2πh c · ℓ 0 (b − 4a) k k E 2 (h) − ∞ h=1 C h (M) sin 2πh c · ℓ 0 (b − 4a) k k E 1 (h) + C 0 (M)1 π M h=1 1 h sin 2πh c · ℓ 0 (b − 4a) k 2k E 3 (h),
where E 3 (h) equals To conclude, we apply Lemma 8.2 to bound each of E 1 (h), E 2 (h), and E 3 (h) by X 5 6 when hX O(δ ′ 2 ) ≤ X γ . Combining this with the trivial bound |E i (h)| ≪ X 1+ε for i = 1, 2, 3 when hX O(δ ′ 2 ) > X γ , and taking M = X γ 8 and δ ′ 2 sufficiently small, we get that the above five quantities are ≪ X 

Theorem 1 . 2 .
12We have #{n ≤ N : Z/(n 2 + n + 1)Z contains a perfect difference set} = (1 + o(1)) N log N .

5 4 > 1 .
51Thus, by an application of an upper bound sieve, we have that (3.1) is bounded above by N (log N ) 5/4 times a quantity of the form

Lemma 4. 3 .
3Let y > 0 and a ∈ Z be nonzero. We have p≤X p∤a L(1, χ ap ; y), p≤X p∤a


n) := #{a (mod n) : a 2 ≡ −3 (mod n)}. Lemma 5.5 below gives a bound for (5.3) after forgetting the condition n ∈ S(N) and making a change of variables. Lemma 5.5. Let X > 0. Then

Set γ := min δ ′ 1 , δ 1 8 and Y := X γ , with δ 1 and δ ′ 1 as in Lemma 5. 4 .
4Fix a smooth function φ : R → R supported on [−1, 1] with φ(0) = 1 and


function D(s) that is holomorphic in the region ℜ(s) > 1/2 and nonvanishing in a neighborhood of s = 1. Thus, L(s) = c ρ ′ (s − 1) + O(|s − 1| 2 ) for some nonzero constant c ρ ′ , since ζ(s) = 1 s−1 + O(1) and D(s) and L(s, χ −3 ) are holomorphic and nonvanishing in a neighborhood of s = 1. As a consequence, when |u i | ≤ (log Y ) 1/2 for each i = 1

Lemma 6 . 5 .
65We have #{n ∈ S(N) : n 2 + n + 1 is prime and congruent to 1 (mod 4)} ≪ N log N exp(C log 5 N log 6 N ) for some absolute constant C > 0.

N
(log N ) 3/2 and ≪ N log N (log 4 N ) 1/2 , respectively. So it remains to bound the sum of the #T p 1 ,...,p k (N)'s. By Lemma 2.2, we have that T p 1 ,...,p k (N) ⊂ T ′ p 1 ,...,p k (N), where T ′ p 1 ,...,p k (N) := n ≤ N : n 2 + n + 1 ≡ 1 (mod 4) is prime and p i (n) = p i and p i n 2 + n + 1 4 = 1 for i = 1, . . . , k .


when q = x 2 + 4y 2 . So, splitting n ∈ T ′ p 1 ,...,p k (N) up based on whether n ≡ 0, 7 (mod 8) or n ≡ 3, 4 (mod 8), we see that p i n 2 +n+1 4 = 1 if and only if n 2 + n + 1 can be written in the form x 2 + 4y 2 with y ≡ a (mod p i ) for some a (mod p i ) such that both 1 + 2a and 1 − 2a are quadratic residues (if (


(mod r) n≡j (mod 8) p i (n)=p i for i=1,...,k m a (n).

Proposition 7 . 1 (
71Duke, Friedlander,  and Iwaniec, Proposition 4 of[4]). Let f : R → R be a function supported on [X, 2X] satisfying

. 4 .
4|f (i) (t)| ≪ t −i for each i = 0, . . . , 4.Then, for all h ≪ X, We begin by writing the size of the set in Lemma 5.


+ br), and note that M ≪ c and c 2 −M 2 ≫ c 2 X −O(γ) . Using partial summation, we can bound (8.5) by |g c (M) ||ψ 1 (c, M + 1) | + m≤t≤M |g c (t)||ψ 1 (c, t) − ψ 1 (c, t + 1)| and (8.6) by |g c (M) ||ψ 2 (c, M + 1) | + m≤t≤M |g c (t)||ψ 2 (c, t) − ψ 2 (c,


0 . Indeed, for each fixed d-tuple e = (e 1 , . . . , e d ) and congruence class w modulo ℓ 0 , there exists a constant P ′ e,w such that that P u = u · P ′ (mod ℓ 0 ) (just take P u = w ℓ 0 b e u where w ℓ 0 denotes the multiplicative inverse of w modulo ℓ 0 and b e ≡ j =i r e j j (mod r e i i ) for each i = 1, . . . , d). So, with γ as in Lemma 8.2, we write the first sum above as e 1 ,...,


c · ℓ 0 (b − 4a) k 2k E 2 (h),


error term that is at most an absolute constant times∞ h=1 C h (M) cos 2πh c · ℓ 0 (b − 4a) k 2k E 3 (h) + C 0 (M)


, respectively. This completes the proof of the lemma.


2Y ], is identically X −12/200 on [5Y /4, 7Y /4], and, by the chain rule, satisfies
4 ).
, where e c (z) := e(z/c). The above can be rewritten as ℓ 0 kn 2 +c 2 =as+br≤t(8.7)e c −h · −3ℓ 0 vn 2 + (ℓ 0 kn 2 + c 2 ) c (−3ℓ 0 vc 2 n 2 + c 3 (n 1 )) ,where c 3 (n 1 ) = w ′ + ℓ 0 vc 1 n 1 , since ℓ 0 vn 1 (ℓ 0 kn 1 + 2c 1 ) ≡ ℓ 0 vn 1 c 1 (mod ℓ 0 kn 1 + c 1 ). With a view towards using the Pólya-Vinogradov method to bound g c (t), we will first consider complete sums of the formfor all ξ (mod c). Also define, for all prime powers p e c, the sum s p e (ξ) to beBy the Chinese remainder theorem, we haveAs a consequence,|s p e (ξ, c 3 (n 1 ))|, so that, to bound |s(ξ)|, it suffices to bound each of the s p e (ξ, c 3 (n 1 ))'s when p ∤ hkℓ.If p ∤ kℓ, then ℓ 0 k is invertible modulo p e for any e > 0, and so we can write, and wk − vℓ 0 d = 1, a short manipulation gives 3kvc 2 2 + c 3 (n 1 ) ≡ k (mod p e ). Thus,so that s p e (ξ, c 3 (n 1 )) is a complete Kloosterman sum. We therefore have that |s p e (ξ, c 3 (n 1 ))| ≤ (e + 1)p e since gcd(p, h) = 1. (See Theorem 2 of[11], for example, for a statement of a general bound for Kloosterman sums. The above is the Weil bound for e = 1, and is due to Salié for e > 1.) We conclude thatTo use the Pólya-Vinogradov method, we will also require bounds for the Fourier coefficients of the subset of integersfor some interval I = I a,b,c,b 1 ,b 2 ,t,ℓ 0 ,ℓ,k of length less than c. Thus, we have | T c (0)| < c and, forNoting that gcd(ℓ 0 ℓ, c) = 1, we conclude using Parseval's identity thatCombining this with our bounds involving ψ 1 (c, t) and ψ 2 (c, t) above, we deduce from our application of partial summation that the sums(Proof of Lemma 6.4. The proof of Lemma 6.4 follows the same general outline of the proof of Lemma 5.4. However, we are concerned with a different hyperboloid, so we note it suffices to prove that(1 + χ 12 (q j )) δ 1 4 (a (mod q j )) 2 δ ± 1 2 (a (mod q j )) · p|r (1 + χ −1 (p)) 1+δ b 4 (a (mod p)) 2 δ 0 (a (mod p)) , 3 s , and for all p > 3 with p ∤ ℓ, we have the local factorFor p | k, the local factor is just 1, and for p | ℓ 0 , we have the local factorIt then follows from a small amount of manipulation thatso thatThus, χ(ℓ 0 )ℓ s 0 L χ (s) is holomorphic for ℜ(s) ≥ 1 2 except, when χ is the trivial character, for a pole of residuewhere C ′ > 0 is an absolute constant. As in the proof of Lemma 5.4, a standard contour integration tells us thatwhen χ is nontrivial, andwhen χ is trivial. Now, using the orthogonality of Dirichlet characters, we have thatfrom which it follows from partial summation that the main term of (8.10) equals
The "large sieve" method and its application to number theory. Uspehi Mat. Nauk. M B Barban, 21M. B. Barban. The "large sieve" method and its application to number theory. Uspehi Mat. Nauk, 21(1):51-102, 1966.

On the existence of cyclic difference sets with small parameters. L D Baumert, D M Gordon, High primes and misdemeanours: lectures in honour of the 60th birthday of Hugh Cowie Williams. Providence, RIAmer. Math. Soc41L. D. Baumert and D. M. Gordon. On the existence of cyclic difference sets with small parameters. In High primes and misdemeanours: lectures in honour of the 60th birthday of Hugh Cowie Williams, volume 41 of Fields Inst. Commun., pages 61-68. Amer. Math. Soc., Providence, RI, 2004.

The nonexistence of certain finite projective planes. Canad. R H Bruck, H J Ryser, J. Math. 1R. H. Bruck and H. J. Ryser. The nonexistence of certain finite projective planes. Canad. J. Math., 1:88-93, 1949.

Equidistribution of roots of a quadratic congruence to prime moduli. W Duke, J B Friedlander, H Iwaniec, Ann. of Math. 1412W. Duke, J. B. Friedlander, and H. Iwaniec. Equidistribution of roots of a quadratic congruence to prime moduli. Ann. of Math. (2), 141(2):423-441, 1995.

Weyl sums for quadratic roots. W Duke, J B Friedlander, H Iwaniec, Int. Math. Res. Not. IMRN. 11W. Duke, J. B. Friedlander, and H. Iwaniec. Weyl sums for quadratic roots. Int. Math. Res. Not. IMRN, (11):2493-2549, 2012.

On simple difference sets. T A Evans, H B Mann, 11SankhyāT. A. Evans and H. B. Mann. On simple difference sets. Sankhyā, 11:357-364, 1951.

Opera de cribro. J Friedlander, H Iwaniec, American Mathematical Society57Providence, RIJ. Friedlander and H. Iwaniec. Opera de cribro, volume 57 of American Mathematical Society Colloquium Publications. American Mathematical Society, Providence, RI, 2010.

The distribution of values of L(1, χ d ). A Granville, K Soundararajan, Geom. Funct. Anal. 135A. Granville and K. Soundararajan. The distribution of values of L(1, χ d ). Geom. Funct. Anal., 13(5):992-1028, 2003.

Unsolved problems in number theory. R K Guy, Problem Books in Mathematics. Springer-Verlagsecond edition. Unsolved Problems in Intuitive Mathematics, IR. K. Guy. Unsolved problems in number theory. Problem Books in Mathematics. Springer-Verlag, New York, second edition, 1994. Unsolved Problems in Intuitive Mathematics, I.

Cyclic projective planes. M HallJr, Duke Math. J. 14M. Hall, Jr. Cyclic projective planes. Duke Math. J., 14:1079-1090, 1947.

An asymptotic formula in the theory of numbers. C Hooley, Proc. London Math. Soc. 73C. Hooley. An asymptotic formula in the theory of numbers. Proc. London Math. Soc. (3), 7:396-413, 1957.

On the number of divisors of a quadratic polynomial. C Hooley, Acta Math. 110C. Hooley. On the number of divisors of a quadratic polynomial. Acta Math., 110:97-114, 1963.

Difference sets: an introduction. In Difference sets, sequences and their correlation properties. D Jungnickel, A Pott, NATO Adv. Sci. Inst. Ser. C Math. Phys. Sci. 542Kluwer Acad. PublD. Jungnickel and A. Pott. Difference sets: an introduction. In Difference sets, sequences and their correlation properties (Bad Windsheim, 1998), volume 542 of NATO Adv. Sci. Inst. Ser. C Math. Phys. Sci., pages 259-295. Kluwer Acad. Publ., Dordrecht, 1999.

On the geometry of planar difference sets. D Jungnickel, K Vedder, European J. Combin. 52D. Jungnickel and K. Vedder. On the geometry of planar difference sets. European J. Combin., 5(2):143- 148, 1984.

On the mean value of L( 1 2 , χ) for real characters. M Jutila, Analysis. 12M. Jutila. On the mean value of L( 1 2 , χ) for real characters. Analysis, 1(2):149-161, 1981.

Reciprocity laws. F Lemmermeyer, Springer Monographs in Mathematics. BerlinSpringer-VerlagFrom Euler to EisensteinF. Lemmermeyer. Reciprocity laws. Springer Monographs in Mathematics. Springer-Verlag, Berlin, 2000. From Euler to Eisenstein.

Some theorems on difference sets. H B Mann, Canad. J. Math. 4H. B. Mann. Some theorems on difference sets. Canad. J. Math., 4:222-226, 1952.

A theorem in finite projective geometry and some applications to number theory. J Singer, Trans. Amer. Math. Soc. 433J. Singer. A theorem in finite projective geometry and some applications to number theory. Trans. Amer. Math. Soc., 43(3):377-385, 1938.

Collected mathematical papers. H J S Smith, 1H. J. S. Smith. Collected mathematical papers, volume 1. 1894.

Obstructions to uniformity and arithmetic patterns in the primes. T Tao, Special Issue: In honor of John H. 2Coates. PartT. Tao. Obstructions to uniformity and arithmetic patterns in the primes. Pure Appl. Math. Q., 2(2, Special Issue: In honor of John H. Coates. Part 2):395-433, 2006.

A note on planar difference sets. H A Wilbrink, J. Combin. Theory Ser. A. 381Radcliffe Observatory QuarterMathematical Institute, University of OxfordUnited Kingdom Email address: sarah.peluse@maths.ox.ac.ukH. A. Wilbrink. A note on planar difference sets. J. Combin. Theory Ser. A, 38(1):94-95, 1985. Mathematical Institute, University of Oxford, Radcliffe Observatory Quarter, Wood- stock Road, Oxford OX2 6GG, United Kingdom Email address: sarah.peluse@maths.ox.ac.uk
